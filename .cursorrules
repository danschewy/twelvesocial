Next.js Video Clip Generator App Outline
This outline details the structure and key components of your Next.js application, designed to help users transform long videos into social media-ready clips using AI.

I. Project Structure
/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ index.tsx             # Landing page / Get Started
â”‚   â”œâ”€â”€ upload.tsx            # Video upload interface
â”‚   â”œâ”€â”€ chat.tsx              # Main chatbot interaction and video preview
â”‚   â””â”€â”€ results.tsx           # Display generated clips and social media posts
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ layout/               # General layout components (Header, Footer)
â”‚   â”‚   â””â”€â”€ Layout.tsx
â”‚   â”œâ”€â”€ ui/                   # Reusable UI components (buttons, inputs, modals)
â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”œâ”€â”€ Input.tsx
â”‚   â”‚   â””â”€â”€ Modal.tsx
â”‚   â”œâ”€â”€ VideoUploader.tsx     # Handles video file input and upload
â”‚   â”œâ”€â”€ ChatInterface.tsx     # Displays chat messages and input field
â”‚   â”œâ”€â”€ VideoPlayer.tsx       # Embeds video player for preview
â”‚   â”œâ”€â”€ ClipPreviewCard.tsx   # Displays individual generated clips
â”‚   â””â”€â”€ SocialPostPreview.tsx # Shows generated text post with options
â”œâ”€â”€ api/                      # Next.js API Routes (server-side logic)
â”‚   â”œâ”€â”€ upload-video.ts       # Handles video file upload to cloud storage / Twelve Labs
â”‚   â”œâ”€â”€ process-video.ts      # Triggers Twelve Labs video indexing
â”‚   â”œâ”€â”€ chat.ts               # Proxies requests to LangChain/OpenAI chatbot
â”‚   â”œâ”€â”€ search-clips.ts       # Queries Twelve Labs for relevant video segments
â”‚   â”œâ”€â”€ generate-clip.ts      # Uses FFmpeg to stitch video clips
â”‚   â””â”€â”€ generate-social-post.ts # Generates social media text using OpenAI/Twelve Labs
â”œâ”€â”€ lib/                      # Server-side utility functions and API clients
â”‚   â”œâ”€â”€ twelvelabs.ts         # Twelve Labs API client wrapper
â”‚   â”œâ”€â”€ openai.ts             # OpenAI API client wrapper
â”‚   â”œâ”€â”€ langchain.ts          # LangChain setup and chatbot integration
â”‚   â”œâ”€â”€ ffmpeg.ts             # FFmpeg command execution utilities
â”‚   â””â”€â”€ utils.ts              # General utility functions
â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ globals.css           # Global Tailwind CSS imports and custom styles
â”‚   â””â”€â”€ tailwind.config.js    # Tailwind CSS configuration
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â””â”€â”€ images/               # Static assets
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ index.d.ts            # TypeScript type definitions
â”œâ”€â”€ .env.local                # Environment variables
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tsconfig.json
â””â”€â”€ package.json

II. Core Pages & Components
pages/index.tsx (Landing Page)

Purpose: Introduce the application, its benefits, and guide users to start.

Content:

Catchy headline and brief description.

"Get Started" button linking to /upload.

Optional: Feature highlights, examples of generated clips.

pages/upload.tsx (Video Upload)

Purpose: Allow users to upload their video files.

Components:

<VideoUploader />:

Drag-and-drop area or file input button.

Progress indicator during upload.

Validation for file types (e.g., MP4, MOV).

Once uploaded, navigate to /chat with video ID.

API Interaction: Calls /api/upload-video to handle the file.

pages/chat.tsx (Chatbot Interaction & Video Preview)

Purpose: The main interface where users interact with the chatbot and see their video.

Components:

<VideoPlayer />: Displays the uploaded video. Can be updated to show selected clips later.

<ChatInterface />:

Displays chat history (user and bot messages).

Text input field for user messages.

"Send" button.

Loading indicator when the bot is thinking.

State Management: Manages chat history, video metadata, and current processing status.

API Interaction: Calls /api/chat for chatbot responses. Once the chatbot determines the video clips, it triggers /api/search-clips.

pages/results.tsx (Generated Clips & Social Post)

Purpose: Present the generated video clips and suggested social media posts.

Components:

List of <ClipPreviewCard /> components:

Each card shows a thumbnail, duration, and a brief description of the clip.

Options to play, download, or edit the clip.

Option to select/deselect clips for the final output.

<SocialPostPreview />:

Displays the AI-generated text post.

Options to copy, edit, or regenerate the post.

Buttons for direct sharing to social media (e.g., "Share to Instagram").

API Interaction: Triggers /api/generate-clip for final video stitching and /api/generate-social-post for text.

III. API Routes (/api)
/api/upload-video.ts:

Receives video file from frontend.

Action: Uploads the video to a temporary storage (e.g., AWS S3, Google Cloud Storage) and then initiates the upload to Twelve Labs.

Response: Returns a video ID from Twelve Labs for subsequent processing.

/api/process-video.ts:

Receives the Twelve Labs video ID.

Action: Calls the Twelve Labs API to start indexing and processing the video.

Response: Status of the indexing job.

/api/chat.ts:

Receives user message and chat history.

Action: Passes the input to your LangChain setup, which integrates with OpenAI. The LangChain agent will use the system prompt to determine the user's intent and formulate a response or an action (like searching for clips).

Response: Chatbot's textual response or a signal to proceed with clip generation.

/api/search-clips.ts:

Receives the Twelve Labs video ID and the search query (generated by the chatbot).

Action: Calls the Twelve Labs API to search for relevant segments within the indexed video.

Response: Returns a list of potential clip segments (start/end times, confidence scores).

/api/generate-clip.ts:

Receives the Twelve Labs video ID and selected clip segments (start/end times).

Action: Downloads the necessary video segments (or uses Twelve Labs' clip export if available) and uses FFmpeg (server-side) to stitch them together into a single video file.

Response: URL to the generated video clip.

/api/generate-social-post.ts:

Receives context about the generated clips (e.g., themes, keywords, original user intent).

Action: Uses OpenAI (or Twelve Labs' captioning feature if suitable) to generate a compelling social media text post, including relevant hashtags and emojis.

Response: Suggested social media text.

IV. Backend Logic (lib/)
lib/twelvelabs.ts:

Functions for uploading videos, checking indexing status, searching for clips, and potentially exporting clips.

lib/openai.ts:

Client initialization for OpenAI.

lib/langchain.ts:

Sets up your LangChain agent. This is where the system prompt is injected, and where you might define tools for your agent (e.g., a "search_video_clips" tool that calls your /api/search-clips endpoint).

lib/ffmpeg.ts:

Utility functions to execute FFmpeg commands on the server to cut and stitch video segments. This will likely involve spawning a child process.

Chatbot System Prompt & Initial Questions
This section outlines the core intelligence of your application â€“ the chatbot's system prompt and how it will initiate interaction with users.

I. Chatbot System Prompt (LangChain/OpenAI)
The system prompt is crucial for guiding the LLM's behavior and ensuring it understands its role.

You are an AI video assistant specialized in helping users create engaging social media clips from their uploaded videos. Your primary goal is to understand the user's intent for their video and guide them through the process of generating relevant clips and accompanying social media text.

You have access to a video analysis and clip generation system (Twelve Labs, FFmpeg, OpenAI). Your task is to interpret user requests and formulate clear instructions or queries for this system.

**Here are the main scenarios you need to handle:**

1.  **Direct Clip Request:** The user explicitly states what kind of clip they want.
    * **Example:** "I want a 30-second highlight reel of the best plays." or "Find all instances where I talk about 'innovation'."
    * **Your Action:** Extract the specific theme, keywords, desired duration, and any other constraints. Formulate a precise search query for the video analysis system.

2.  **Multi-Topic or Segment Showcase:** The user has a video covering several distinct topics, activities, product features, or segments and wants to create separate clips for each.
    (This could be a professional showcasing different aspects of their work, a product demo highlighting various features, an event recording with multiple segments, or any video where distinct parts need to be isolated).
    * **Example:** "This video showcases my recent projects: a kitchen remodel, a bathroom renovation, and a deck build. I need separate clips for each." or "This product demo covers feature A, feature B, and feature C. Can you create clips for each feature?" or "I'm an electrician, this video shows a panel upgrade and new wiring installation. I want clips for each."
    * **Your Action:** Identify the distinct topics, segments, or items the user wants to highlight. For each, formulate a search query (or guide the user to provide keywords if needed) to find relevant video segments. Aim to find one or more distinct clips for each identified item.

3.  **How-To / Tutorial Video Breakdown:** The user uploads a tutorial and wants to break it down into actionable steps or key sections.
    * **Example:** "This is a cooking tutorial for making pasta. Can you break it down into steps like 'preparing ingredients,' 'making dough,' 'cooking sauce,' and 'plating'?" or "This video explains how to change a tire. I need clips for each major step."
    * **Your Action:** Understand the sequential nature of the video. Identify the distinct steps or phases the user wants to highlight. Formulate queries to find the beginning and end of each step, creating a logical progression of clips.

**Your Guiding Principles:**

* **Clarification:** If a user's request is vague or ambiguous, ask clarifying questions to narrow down their intent.
* **Confirmation:** Before proceeding with clip generation, confirm your understanding of their request.
* **Guidance:** Proactively suggest ways to get the best clips (e.g., "What are the key moments you want to highlight?").
* **Conciseness:** Provide helpful but brief responses.
* **Action-Oriented:** Your ultimate goal is to generate the necessary parameters for the video processing system.

**Constraints:**

* Do not ask for personal information.
* Do not generate clips without explicit user confirmation of the search criteria.
* Always be polite and helpful.
* Assume the video has already been uploaded and indexed by the system.

II. Initial Chatbot Questions
These questions will be pre-loaded or immediately prompted by the chatbot after a user uploads a video, helping to quickly ascertain their goal.

"Thanks for uploading your video! To help me create the best social media clips, could you tell me a bit about its content and what you're hoping to achieve?"

"Are you looking for specific moments or themes from the video, or do you want to break it down into different sections?"

"For example, are you trying to:

A. Highlight specific actions or topics (e.g., 'best moments,' 'mentions of X')?

B. Showcase different topics, segments, or categories from the video (e.g., 'different services offered,' 'product features,' 'parts of a project,' 'event agenda items')?

C. Break down a 'how-to' or tutorial video into sequential steps (e.g., 'step 1,' 'step 2')?
Please tell me which option best fits your goal, or describe it in your own words!"

(If user selects B or C, follow up with): "Great! Can you tell me more about the specific topics/segments you're interested in (if you selected B), or the particular steps you'd like to highlight (if you selected C)?"

(General follow-up): "What's the main message or feeling you want your social media clips to convey?"

This comprehensive outline should give you a solid foundation for building your Next.js video clip generation tool!

# Instructions

During your interaction with the user, if you find anything reusable in this project (e.g. version of a library, model name), especially about a fix to a mistake you made or a correction you received, you should take note in the `Lessons` section in the `.cursorrules` file so you will not make the same mistake again. 

You should also use the `.cursorrules` file as a Scratchpad to organize your thoughts. Especially when you receive a new task, you should first review the content of the Scratchpad, clear old different task if necessary, first explain the task, and plan the steps you need to take to complete the task. You can use todo markers to indicate the progress, e.g.
[X] Task 1
[ ] Task 2

Also update the progress of the task in the Scratchpad when you finish a subtask.
Especially when you finished a milestone, it will help to improve your depth of task accomplishment to use the Scratchpad to reflect and plan.
The goal is to help you maintain a big picture as well as the progress of the task. Always refer to the Scratchpad when you plan the next step.

Write tests first, then the code, then run the tests and update the code until tests pass.

# Tools

Note all the tools are in python. So in the case you need to do batch processing, you can always consult the python files and write your own script.

## Screenshot Verification

The screenshot verification workflow allows you to capture screenshots of web pages and verify their appearance using LLMs. The following tools are available:
```bash
venv/bin/python tools/screenshot_utils.py URL [--output OUTPUT] [--width WIDTH] [--height HEIGHT]
```

2. LLM Verification with Images:
```bash
venv/bin/python tools/llm_api.py --prompt "Your verification question" --provider {openai|anthropic} --image path/to/screenshot.png
```

Example workflow:
```python
from screenshot_utils import take_screenshot_sync
from llm_api import query_llm

# Take a screenshot

screenshot_path = take_screenshot_sync('https://example.com', 'screenshot.png')

# Verify with LLM

response = query_llm(
    "What is the background color and title of this webpage?",
    provider="openai",  # or "anthropic"
    image_path=screenshot_path
)
print(response)
```

## LLM

You always have an LLM at your side to help you with the task. For simple tasks, you could invoke the LLM by running the following command:
```
venv/bin/python ./tools/llm_api.py --prompt "What is the capital of France?" --provider "anthropic"
```

The LLM API supports multiple providers:
- OpenAI (default, model: gpt-4o)
- Azure OpenAI (model: configured via AZURE_OPENAI_MODEL_DEPLOYMENT in .env file, defaults to gpt-4o-ms)
- DeepSeek (model: deepseek-chat)
- Anthropic (model: claude-3-sonnet-20240229)
- Gemini (model: gemini-pro)
- Local LLM (model: Qwen/Qwen2.5-32B-Instruct-AWQ)

But usually it's a better idea to check the content of the file and use the APIs in the `tools/llm_api.py` file to invoke the LLM if needed.

## Web browser

You could use the `tools/web_scraper.py` file to scrape the web.
```
venv/bin/python ./tools/web_scraper.py --max-concurrent 3 URL1 URL2 URL3
```
This will output the content of the web pages.

## Search engine

You could use the `tools/search_engine.py` file to search the web.
```
venv/bin/python ./tools/search_engine.py "your search keywords"
```
This will output the search results in the following format:
```
URL: https://example.com
Title: This is the title of the search result
Snippet: This is a snippet of the search result
```
If needed, you can further use the `web_scraper.py` file to scrape the web page content.

# Lessons

## User Specified Lessons

- You have a python venv in ./venv. Use it.
- Include info useful for debugging in the program output.
- Read the file before you try to edit it.
- Due to Cursor's limit, when you use `git` and `gh` and need to submit a multiline commit message, first write the message in a file, and then use `git commit -F <filename>` or similar command to commit. And then remove the file. Include "[Cursor] " in the commit message and PR title.

## Cursor learned

- For search results, ensure proper handling of different character encodings (UTF-8) for international queries
- Add debug information to stderr while keeping the main output clean in stdout for better pipeline integration
- When using seaborn styles in matplotlib, use 'seaborn-v0_8' instead of 'seaborn' as the style name due to recent seaborn version changes
- Use 'gpt-4o' as the model name for OpenAI's GPT-4 with vision capabilities
- When enhancing AI chat context, fetch rich video details (filename, duration, resolution) to provide better context for more efficient clip generation
- Use GPT-4o model for better video understanding and context awareness in chat systems

# Scratchpad

## âœ… COMPLETED: Social Preview Page Redesign

**Task Understanding**: Redesigned the social preview page to match the app's aesthetic and improve readability.

**ðŸŽ¯ IMPLEMENTATION COMPLETED**:

### 1. âœ… Applied App Design System
- **Dark Gradient Background**: Used `from-[#2e026d] to-[#15162c]` matching main app
- **Purple Accent Color**: Applied `text-[hsl(280,100%,70%)]` for highlights
- **Modern Typography**: Large, bold headings with proper hierarchy
- **Consistent Spacing**: Proper padding, margins, and container sizing

### 2. âœ… Enhanced Visual Design
- **Glass Morphism Cards**: `bg-white/5 backdrop-blur-sm border border-white/10`
- **Improved Loading States**: Animated spinners with branded colors
- **Better Error Handling**: Styled error cards with appropriate icons
- **Enhanced Buttons**: Gradient backgrounds, hover effects, and icons

### 3. âœ… Improved Layout & Readability
- **Two-Column Grid**: Better organization on larger screens
- **Card-Based Sections**: Clear separation of content areas
- **Social Media Preview**: Styled like actual social media post
- **Enhanced Typography**: Better contrast, spacing, and readability

### 4. âœ… Added Interactive Features
- **Better Copy Feedback**: Success state with visual confirmation
- **Improved Navigation**: Styled back button with hover effects
- **Social Media Tips**: Added helpful tips section
- **Enhanced Video Player**: Better styling and error handling

### 5. âœ… Mobile Responsiveness
- **Responsive Grid**: `grid-cols-1 lg:grid-cols-2` for mobile-first design
- **Proper Spacing**: Consistent padding and margins across devices
- **Touch-Friendly**: Larger buttons and touch targets

## ðŸš€ **VISUAL IMPROVEMENTS**:
- **From**: Basic white background with minimal styling
- **To**: Dark gradient with glass morphism cards and modern design
- **Readability**: Improved contrast, typography, and content organization
- **User Experience**: Better loading states, error handling, and feedback
- **Brand Consistency**: Matches main app design with purple accents

## ðŸ“± **FEATURES ADDED**:
- Social media post preview styled like real social platform
- Tips section for social media best practices
- Enhanced copy-to-clipboard with success feedback
- Better video player styling and error handling
- Improved loading and error states

The social preview page now provides a beautiful, modern interface that matches the app's design system and significantly improves readability and user experience! ðŸŽ¨âœ¨

## ðŸ”§ PREVIOUS TASK: Fixing Search Options API Error

**Issue**: Twelve Labs API rejecting search_options[1] parameter - only accepts "visual" and "audio"

**ðŸŽ¯ FIXES APPLIED**:

### 1. âœ… Updated System Prompt (langchain.ts)
- Changed `"conversation"` â†’ `"audio"` 
- Removed `"ocr"` (not supported)
- Updated all examples to use correct options

### 2. âœ… Updated Default Options (upload page)
- Changed default from `["visual", "conversation"]` â†’ `["visual", "audio"]`

### 3. âœ… Enhanced Server Validation (twelvelabs.server.ts)
- Added search options filtering and validation
- Only allows `["visual", "audio"]` to be sent to API
- Defaults to both if invalid options provided
- Added debug logging

### 4. âœ… Enhanced API Debugging (search-clips route)
- Added logging to see received vs sent search options
- Better error tracking

**ðŸ§ª TESTING NEEDED**:
- Try "Create highlight reel" again
- Check console logs for search options being sent
- Verify no more "invalid search_options[1]" errors

## âœ… COMPLETED: 1-Shot Video Clip Generation Implementation

**Task Understanding**: Implemented comprehensive 1-shot video clip generation where users can request clips and get immediate search queries without clarifying questions.

**ðŸŽ¯ IMPLEMENTATION COMPLETED**:

### 1. âœ… Video Analysis API (`/api/analyze-video`)
- Created comprehensive video analysis using Twelve Labs summarization
- Extracts content type (tutorial, interview, presentation, general)
- Identifies key topics, quotes, visual elements
- Generates suggested clip types based on content
- Provides structured insights for AI decision-making

### 2. âœ… Enhanced Video Analysis Types
- Added `VideoAnalysisInsights` and `VideoAnalysis` interfaces
- Structured data for content type, topics, suggested clips
- Supports intelligent clip recommendations

### 3. âœ… Automatic Video Analysis Trigger
- Updated upload flow to automatically analyze videos when selected/uploaded
- Provides rich context immediately when video becomes available
- Handles both new uploads and existing video selection

### 4. âœ… Enhanced Chat API with Rich Context
- Passes comprehensive video analysis to AI
- Includes video metadata, content analysis, and suggested clips
- Provides detailed context string for intelligent decision-making

### 5. âœ… Action-Oriented System Prompt
- **1-SHOT GENERATION RULES**: Immediate action for common requests
- **Intelligent Query Generation**: Uses video analysis for smart queries
- **Content Type Adaptation**: Different strategies for tutorials, interviews, presentations
- **Multi-Query Strategy**: Generates 2-4 complementary queries
- **Examples**: Clear patterns for "highlight reel", "best quotes", etc.
- **FIXED**: Now uses correct search options ("visual", "audio")

### 6. âœ… Updated ChatInterface
- Passes video analysis data to chat API
- Provides immediate context when video is ready
- Shows content type and estimated clip count
- Action-oriented messaging with quick examples

## ðŸš€ **EXPECTED RESULTS**:
- **True 1-Shot Generation**: "Create highlight reel" â†’ Immediate search queries
- **Smart Context Awareness**: AI knows video type, topics, duration
- **Proactive Suggestions**: Based on content analysis
- **Reduced Friction**: No more back-and-forth questioning
- **Intelligent Defaults**: Content-type specific clip strategies
- **API Compatibility**: Correct search options for Twelve Labs API

## ðŸ§ª **TESTING SCENARIOS**:
1. Upload video â†’ Auto-analysis â†’ "Create highlight reel" â†’ Immediate queries (NO API ERRORS)
2. "Find best quotes" â†’ Instant audio-based searches
3. "Break into clips" â†’ Content-type specific segmentation
4. Different video types (tutorial, interview, presentation) â†’ Adapted strategies

## ðŸ“ˆ **PERFORMANCE IMPROVEMENTS**:
- **From**: 3-5 exchanges to get clips
- **To**: 1-2 exchanges maximum
- **Context**: Rich video analysis provides immediate understanding
- **Intelligence**: Content-aware query generation
- **Reliability**: Proper API parameter validation

The system now provides true 1-shot video clip generation with comprehensive video analysis, intelligent AI responses, and proper API compatibility! ðŸŽ¬âœ¨